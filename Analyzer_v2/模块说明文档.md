# BXC视频分析系统模块说明文档





## 系统架构概述

系统采用多线程架构，通过HTTP API接收控制任务，对视频流进行拉取、分析、推流和报警处理。



## 核心模块



### 1. Server（接口服务模块）
- **功能**：提供HTTP REST API服务
- **职责**：
  - 启动HTTP服务器（基于libevent）
  - 处理API请求：`/api/control/add`（添加布控）、`/api/control/cancel`（取消布控）、`/api/controls`（查询所有布控）、`/api/control`（查询单个布控）
  - 将请求转发给Scheduler处理



### 2. Scheduler（调度器模块）

- **功能**：管理多个视频分析任务
- **职责**：
  - 维护ControlExecutor映射表（一个Control对应一个ControlExecutor）
  - 处理布控的添加、删除、查询
  - 管理报警队列，异步处理报警生成
  - 限制最大并发分析路数（controlExecutorMaxNum）



### 3. ControlExecutor（控制执行器模块）

- **功能**：协调单个视频流的完整处理流程
- **职责**：
  - 创建并管理拉流、推流、识别、报警生成模块
  - 启动4个线程：
    1. **拉流线程**（AvPullStream::readThread）：从流媒体服务器拉取视频包
    2. **解码分析线程**（decodeAndAnalyzeVideoThread）：解码视频帧并进行AI识别
    3. **报警生成线程**（GenerateAlarm::generateAlarmThread）：处理报警图片和视频
    4. **推流线程**（AvPushStream::encodeVideoAndWriteStreamThread）：可选，将处理后的视频推送到流媒体服务器



### 4. AvPullStream（拉流模块）

- **功能**：从RTSP/RTMP/HTTP-FLV等协议拉取视频流
- **职责**：
  - 连接流媒体服务器
  - 读取视频包并放入队列
  - 支持硬件解码（NVIDIA CUVID）
  - 自动重连机制



### 5. Analyzer（识别模块）

- **功能**：对视频帧进行AI目标检测
- **职责**：
  - 调用算法API进行目标检测（通过HTTP请求）
  - 在视频帧上绘制检测框和标签
  - 计算检测FPS（保留两位小数）
  - 判断是否发生危险行为（当前逻辑：检测到2个人时触发）



### 6. AvPushStream（推流模块）

- **功能**：将处理后的视频推送到流媒体服务器
- **职责**：
  - 连接推流服务器
  - 将BGR格式视频帧转换为YUV420P
  - 编码并推送视频流
  - 支持硬件编码



### 7. GenerateAlarm（报警生成模块）

- **功能**：生成报警图片和视频
- **职责**：
  - 收集发生事件的视频帧
  - 压缩图片（JPEG格式）
  - 生成报警视频片段
  - 将报警提交到Scheduler的报警队列



### 8. GenerateVideo（视频生成模块）

- **功能**：将报警图片序列合成为视频文件
- **职责**：
  - 接收报警数据（AVSAlarm）
  - 使用FFmpeg将图片序列编码为视频
  - 保存到指定目录



## 模块交互流程



### 启动流程

```
main.cpp
  ├─ 初始化Config（读取配置文件）
  ├─ 创建Scheduler
  ├─ 创建Server并启动HTTP服务
  └─ Scheduler进入主循环
```



### 添加布控流程

```
HTTP请求 → Server::api_control_add
  └─ Scheduler::apiControlAdd
      └─ 创建ControlExecutor
          ├─ AvPullStream::connect()  // 连接拉流
          ├─ AvPushStream::connect()  // 连接推流（可选）
          ├─ 创建Analyzer
          ├─ 创建GenerateAlarm
          └─ 启动4个工作线程
```



### 视频处理流程

```
拉流线程（AvPullStream::readThread）
  └─ 读取视频包 → 放入队列

解码分析线程（decodeAndAnalyzeVideoThread）
  ├─ 从队列获取视频包
  ├─ 解码为YUV420P帧
  ├─ 转换为BGR格式
  ├─ Analyzer::checkVideoFrame()  // AI识别
  ├─ AvPushStream::pushVideoFrame()  // 推流（可选）
  └─ GenerateAlarm::pushVideoFrame()  // 报警处理

推流线程（AvPushStream::encodeVideoAndWriteStreamThread）
  ├─ 从队列获取BGR帧
  ├─ 转换为YUV420P
  ├─ 编码为H264
  └─ 推送到流媒体服务器

报警生成线程（GenerateAlarm::generateAlarmThread）
  ├─ 从队列获取视频帧
  ├─ 检测到事件时收集帧
  ├─ 压缩图片
  └─ 生成报警 → Scheduler::addAlarm()
```



### 报警处理流程

```
Scheduler::handleLoopAlarm（独立线程）
  ├─ 从报警队列获取报警
  ├─ GenerateVideo::run()  // 生成视频文件
  └─ 释放报警资源
```



## 关键技术点

1. **多线程架构**：拉流、解码分析、推流、报警生成各自独立线程，通过队列通信
2. **硬件加速**：支持NVIDIA GPU硬件编解码
3. **自动重连**：拉流失败时自动重连
4. **智能检测**：根据队列状态动态调整检测频率（队列为空时进行检测）
5. **资源管理**：使用对象池管理报警图片资源，避免频繁分配释放



## API接口

- `GET /` - API文档
- `POST /api/health` - 健康检查
- `POST /api/control/add` - 添加布控
- `POST /api/control/cancel` - 取消布控
- `POST /api/controls` - 查询所有布控
- `POST /api/control` - 查询单个布控



## 依赖库

- **FFmpeg**：音视频编解码
- **OpenCV**：图像处理
- **libevent**：HTTP服务器
- **jsoncpp**：JSON解析
- **libcurl**：HTTP客户端（算法API调用）
- **turbojpeg**：JPEG压缩（Windows Release版本）

